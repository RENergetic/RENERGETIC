#upstream backislands {
#    server backdb-sv:8082;
#}
#
#upstream backbuildings {
#    server backbuildings-sv:8088;
#}

upstream wso {
    server wso-sv:8280;
}

#upstream grafana {
#    server grafana-sv:3000;
#}

upstream keycloak {
    server keycloak-sv:8080;
}

server {
    listen       8080;
    listen  [::]:8080;
    server_name  localhost;

    proxy_set_header X-Forwarded-For $proxy_protocol_addr; # To forward the original client's IP address 
    proxy_set_header X-Forwarded-Proto $scheme; # to forward the  original protocol (HTTP or HTTPS)
    proxy_set_header Host $host; # to forward the original host requested by the client
    
    #access_log  /var/log/nginx/host.access.log  main;
#    location ^~ /api/islands {
#        proxy_pass http://backislands;
#    }

#    location ^~ /api/buildings {
#        proxy_pass http://backbuildings;
#    }

    location ^~ /api- {
        proxy_set_header apikey eyJ4NXQiOiJOMkpqTWpOaU0yRXhZalJrTnpaalptWTFZVEF4Tm1GbE5qZzRPV1UxWVdRMll6YzFObVk1TlE9PSIsImtpZCI6ImdhdGV3YXlfY2VydGlmaWNhdGVfYWxpYXMiLCJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJzdWIiOiJhZG1pbkBjYXJib24uc3VwZXIiLCJhcHBsaWNhdGlvbiI6eyJvd25lciI6ImFkbWluIiwidGllclF1b3RhVHlwZSI6bnVsbCwidGllciI6IlVubGltaXRlZCIsIm5hbWUiOiJSZW5lcmdldGljQXBwIiwiaWQiOjIsInV1aWQiOiIyYjkzMjBiYy0wOTM3LTQzYTMtYTAwZi04OTk5N2U4YWY4YmMifSwiaXNzIjoiaHR0cHM6XC9cL2xvY2FsaG9zdDo5NDQzXC9vYXV0aDJcL3Rva2VuIiwidGllckluZm8iOnsiVW5saW1pdGVkIjp7InRpZXJRdW90YVR5cGUiOiJyZXF1ZXN0Q291bnQiLCJncmFwaFFMTWF4Q29tcGxleGl0eSI6MCwiZ3JhcGhRTE1heERlcHRoIjowLCJzdG9wT25RdW90YVJlYWNoIjp0cnVlLCJzcGlrZUFycmVzdExpbWl0IjowLCJzcGlrZUFycmVzdFVuaXQiOm51bGx9fSwia2V5dHlwZSI6IlBST0RVQ1RJT04iLCJwZXJtaXR0ZWRSZWZlcmVyIjoiIiwic3Vic2NyaWJlZEFQSXMiOlt7InN1YnNjcmliZXJUZW5hbnREb21haW4iOiJjYXJib24uc3VwZXIiLCJuYW1lIjoiTWVhc3VyZW1lbnRBUEkiLCJjb250ZXh0IjoiXC9hcGktaW5mbHV4XC8xLjAiLCJwdWJsaXNoZXIiOiJhZG1pbiIsInZlcnNpb24iOiIxLjAiLCJzdWJzY3JpcHRpb25UaWVyIjoiVW5saW1pdGVkIn0seyJzdWJzY3JpYmVyVGVuYW50RG9tYWluIjoiY2FyYm9uLnN1cGVyIiwibmFtZSI6IlBvc3RncmVTUUxBUEkiLCJjb250ZXh0IjoiXC9hcGktcG9zdGdyZVwvMS4wIiwicHVibGlzaGVyIjoiYWRtaW4iLCJ2ZXJzaW9uIjoiMS4wIiwic3Vic2NyaXB0aW9uVGllciI6IlVubGltaXRlZCJ9XSwidG9rZW5fdHlwZSI6ImFwaUtleSIsInBlcm1pdHRlZElQIjoiIiwiaWF0IjoxNjU1OTc3NTMwLCJqdGkiOiIzNjU4YTRjZS0yZWM2LTQ1NTAtYmU3NS03YTU2NmJmZWMxOWQifQ==.Q9W9UF0hDxfcmJOsLOkH3e8RPEsa1KDK7ekxlg-HDevIFh_RP39UnKX3IZqQv3RET2KRNmWuBsMhYGdnvhQBUjbVqN0PgfEYam1zSW9h696k8VziFp4vzU9wmA2uqKspzBe5ugCE1K9JDPUE6VrAUmh7Zbff-h66lo_frrhntYTdummKYnG_zILefZMX2lHI_J3q6Arbi76Ss_SJdHvsN2feiojAK91hPPfTlaNGi4kBsK_hPgmwiDs-_MjvH1cNbwQatdcvA7wnY79tYabhs-dJT85qArmuqA1R-Tvvd8k63vFLMhEFpZJuklYkPGFDQkR9SlWMdk68q12E1MEqfw==;

        proxy_pass http://wso;
    }

#    location ^~ (/api/buildings(/.*)?) {
#        add_header apikey "eyJ4NXQiOiJOVGRtWmpNNFpEazNOalkwWXpjNU1tWm1PRGd3TVRFM01XWXdOREU1TVdSbFpEZzROemM0WkE9PSIsImtpZCI6ImdhdGV3YXlfY2VydGlmaWNhdGVfYWxpYXMiLCJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJzdWIiOiJhZG1pbkBjYXJib24uc3VwZXIiLCJhcHBsaWNhdGlvbiI6eyJvd25lciI6ImFkbWluIiwidGllclF1b3RhVHlwZSI6bnVsbCwidGllciI6IlVubGltaXRlZCIsIm5hbWUiOiJyZW5lcmdldGljLWFwcCIsImlkIjozLCJ1dWlkIjoiMDRkODM4M2QtMjU0NS00NTI4LWI0MGYtODFhZWRlMmZiMmE5In0sImlzcyI6Imh0dHBzOlwvXC9sb2NhbGhvc3Q6OTQ0M1wvb2F1dGgyXC90b2tlbiIsInRpZXJJbmZvIjp7IlVubGltaXRlZCI6eyJ0aWVyUXVvdGFUeXBlIjoicmVxdWVzdENvdW50IiwiZ3JhcGhRTE1heENvbXBsZXhpdHkiOjAsImdyYXBoUUxNYXhEZXB0aCI6MCwic3RvcE9uUXVvdGFSZWFjaCI6dHJ1ZSwic3Bpa2VBcnJlc3RMaW1pdCI6MCwic3Bpa2VBcnJlc3RVbml0IjpudWxsfX0sImtleXR5cGUiOiJQUk9EVUNUSU9OIiwicGVybWl0dGVkUmVmZXJlciI6IiIsInN1YnNjcmliZWRBUElzIjpbeyJzdWJzY3JpYmVyVGVuYW50RG9tYWluIjoiY2FyYm9uLnN1cGVyIiwibmFtZSI6IkJ1aWxkaW5nc0FQSSIsImNvbnRleHQiOiJcL2J1aWxkaW5nc1wvMS4wIiwicHVibGlzaGVyIjoiYWRtaW4iLCJ2ZXJzaW9uIjoiMS4wIiwic3Vic2NyaXB0aW9uVGllciI6IlVubGltaXRlZCJ9XSwidG9rZW5fdHlwZSI6ImFwaUtleSIsInBlcm1pdHRlZElQIjoiIiwiaWF0IjoxNjQxOTc3ODgyLCJqdGkiOiJmZGUwMDUxNy00MjRhLTQ4ZGYtYWQ4Ni1hYTliYjlmZTBhNjAifQ==.UrOsiYc8B5tKlCANPR7A3KsZB61iNH-WHduYPnfyC-gThgDmGpKOiC2gkD_gOiapFLczkTXe6qtid--bF4V1nJmD2DyHe6ELTmMaMdSC-xxnW9XDT8FvYePQhcZfIxSbHzner1zNPUKdpRn1qhZxHotp_F9hmD5fW0VE4D3_IgjWNr0dYsGa5smAjeVSdz8__HuQ1TxzMzyaDg1wD_esBGQ4PvxTvAh40VDGHgU87p0-XsxFM_ddS2dyQ6lJ8qizU7VZ0hbysmc1l3jFlx6l4lJDuCvEqa0RYNUD9xR8CFXfMoegdw4qmhhfyh2stOMHw5WnM94TCPkP2_23Z2pvCQ==";
#
#        proxy_pass http://wso/buildings/1.0/$1;
#    }

#    location ^~ /grafana(/?)(.*) {
#        proxy_pass http://grafana/$2;
#    }

    location ^~ /auth {
        proxy_pass http://keycloak;
    }

    location ^~ / {
        root   /usr/share/nginx/html;
        index  index.html index.htm;
        try_files $uri $uri/ /index.html?uri=$uri;
    }

    #error_page  404              /404.html;

    # redirect server error pages to the static page /50x.html
    #
    error_page   500 502 503 504  /50x.html;
    location = /50x.html {
        root   /usr/share/nginx/html;
    }

    # proxy the PHP scripts to Apache listening on 127.0.0.1:80
    #
    #location ~ \.php$ {
    #    proxy_pass   http://127.0.0.1;
    #}

    # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000
    #
    #location ~ \.php$ {
    #    root           html;
    #    fastcgi_pass   127.0.0.1:9000;
    #    fastcgi_index  index.php;
    #    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;
    #    include        fastcgi_params;
    #}

    # deny access to .htaccess files, if Apache's document root
    # concurs with nginx's one
    #
    #location ~ /\.ht {
    #    deny  all;
    #}
}